# RapidWire コントラクトサンプル

このドキュメントは、RapidWire Discordボット用のコントラクトのサンプル集です。これらの例は、スマートコントラクトシステムの様々な機能を示しています。

## コントラクトの仕組み

コントラクトが設定されたユーザーがトランザクションを受信すると、サンドボックス化された環境でコントラクトコードが実行されます。コントラクトは主に2つのオブジェクトにアクセスできます。

- `tx`: 受信するトランザクションの詳細を含む辞書です。
    - `source`: 送信者のユーザーID。
    - `dest`: 受信者（あなた）のユーザーID。
    - `currency`: 転送される通貨のID。
    - `amount`: 転送される通貨の量（整数）。
    - `input_data`: 送信者によってトランザクションに添付されたデータ。
- `api`: RapidWireシステムと対話するためのメソッドを提供するオブジェクトです。
    - `get_balance(user_id, currency_id)`: ユーザーの残高を取得します。
    - `get_transaction(tx_id)`: 特定のトランザクションを取得します。
    - `transfer(source, dest, currency, amount)`: 新しい送金を開始します。**注意:** `source`はコントラクトの所有者でなければなりません。
    - `search_transactions(...)`: トランザクションを検索します。
    - `get_currency(currency_id)`: 通貨の詳細を取得します。
    - `create_claim(...)`, `get_claim(...)`, `pay_claim(...)`, `cancel_claim(...)`: 請求を管理します。
- `Cancel`: 受信するトランザクションをキャンセルするために発生させることができる例外です (`raise Cancel("キャンセルの理由")`)。
- `return_message`: トランザクションの送信者にメッセージを返すために設定できる変数です。

---

## サンプルコントラクト

### 1. 自動返信コントラクト

これは、送信者に「ありがとう」というメッセージを送り返す基本的なコントラクトです。

**コード:**
```python
# トランザクションの送信元に送信される返信メッセージを設定します。
return_message = f"{tx['amount']} コインありがとうございます！"
```

**説明:**
- このスクリプトは`tx`辞書にアクセスして、受信トランザクションから`amount`を取得します。
- その後、`return_message`変数を設定します。この変数の内容は、送金が正常に処理された後、トランザクションを開始したユーザーに送信されます。

---

### 2. 条件付き拒否コントラクト

このコントラクトは、特定の条件に基づいてトランザクションを拒否する方法を示します。この例では、`input_data`に「fee」が含まれるトランザクションを拒否します。

**コード:**
```python
# input_dataが'fee'かどうかを確認します
if tx['input_data'] == 'fee':
    # もしそうなら、メッセージ付きでトランザクションをキャンセルします。
    raise Cancel("'fee'がinput_dataのトランザクションは受け付けられません。")

return_message = "トランザクションは承認されました。"
```

**説明:**
- スクリプトは`tx`オブジェクトの`input_data`フィールドをチェックします。
- `input_data`が文字列「fee」と一致する場合、スクリプトは`Cancel`例外を発生させます。
- `Cancel`を発生させると、トランザクションは即座に停止し、提供されたメッセージがキャンセルの理由として送信者に送り返されます。
- 条件が満たされない場合、トランザクションは続行され、確認メッセージが設定されます。

---

### 3. チップ転送コントラクト

このコントラクトは、受け取った資金の一部を自動的に別のユーザーに転送します。これは「開発者税」や貯金口座などに使用できます。

**コード:**
```python
# チップを転送する相手のユーザーID。
# 重要: 123456789012345678を実際のDiscordユーザーIDに置き換えてください。
FORWARD_TO_USER_ID = 123456789012345678

# 転送する金額の割合（例: 10%）
TIP_PERCENTAGE = 0.10

# 転送する金額を計算します
tip_amount = int(tx['amount'] * TIP_PERCENTAGE)

# 金額が非常に小さい場合でも、最低1単位は転送されるようにします
if tip_amount == 0 and tx['amount'] > 0:
    tip_amount = 1

# 送信するチップがある場合、それを転送します。
if tip_amount > 0:
    api.transfer(
        source=tx['dest'],  # sourceは常にコントラクトの所有者です
        dest=FORWARD_TO_USER_ID,
        currency=tx['currency'],
        amount=tip_amount
    )
    return_message = f"ありがとうございます！{tip_amount}がチップとして転送されました。"
else:
    return_message = "トランザクションありがとうございます！"
```

**説明:**
- **設定**: `FORWARD_TO_USER_ID`を、資金を送りたい実際のDiscordユーザーIDに設定する必要があります。`TIP_PERCENTAGE`は必要に応じて調整できます。
- **計算**: スクリプトは、受信した`tx['amount']`の`TIP_PERCENTAGE`に基づいて転送する金額を計算します。元の金額がゼロより大きい場合、少なくとも通貨の1単位が送信されることを保証します。
- **API呼び出し**: `api.transfer()`メソッドを使用して、計算された`tip_amount`を送信します。
    - `source`: これは**必ず**`tx['dest']`（コントラクトを所有するアカウントのユーザーID）でなければなりません。コントラクトは自身のアカウントからのみ送金を開始できます。
    - `dest`: 資金を転送する相手のユーザーID。
    - `currency`: 受信トランザクションと同じ通貨。
    - `amount`: 計算されたチップの金額。
- **返信メッセージ**: 元の送信者に、彼らのトランザクションの一部が転送されたことを知らせるメッセージが設定されます。