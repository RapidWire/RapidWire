# VMアーキテクチャとコンパイラ

RapidWireのスマートコントラクトシステムは、Pythonコードを直接実行するのではなく、中間言語（JSON形式の命令セット）にコンパイルしてから、独自の仮想マシン（VM）上で実行するというアーキテクチャを採用しています。

このドキュメントでは、その内部構造について解説します。

## コンパイルプロセス

ユーザーが `.py` ファイルをアップロードすると、`compiler.py` が以下の手順で処理を行います。

1.  **AST解析**: Pythonの標準ライブラリ `ast` を使用して、ソースコードを抽象構文木（AST）に解析します。
2.  **`main` 関数の抽出**: コード内から `def main():` ブロックを探し出します。それ以外のトップレベルコードは無視されます。
3.  **命令変換**: ASTノードを一つずつ巡回し、RapidWire VMが理解できるJSON形式の命令オブジェクトに変換します。
    - 例: `a = b + 1` → `{'op': 'add', 'args': [{'t': 'var', 'v': 'b'}, {'t': 'int', 'v': 1}], 'out': 'a'}`

### 命令フォーマット
各命令は以下のキーを持つ辞書オブジェクトです。

- **`op`**: オペレーションコード（命令の種類）。例: `add`, `set`, `transfer`, `if`.
- **`args`**: 引数のリスト。各引数は型情報を持つオブジェクト `{'t': type, 'v': value}` です。
- **`out` (任意)**: 結果を格納する変数名。

## 仮想マシン (VM) の仕様

`vm.py` はコンパイルされた命令リストを上から順に実行するインタプリタです。

### メモリ管理
- **変数**: すべての変数はVM内の辞書で管理されます。
- **制限**:
    - **メモリ制限**: 変数の合計サイズが一定量（`MAX_VM_MEMORY`）を超えると強制終了します。
    - **数値制限**: 巨大すぎる整数（10^30超）は扱えません。
    - **文字列長**: 文字列の長さにも制限があります。

### Gas (実行コスト)
無限ループなどを防ぐため、各命令には「コスト（Cost）」が設定されています。
実行ごとにコストが加算され、設定された `max_cost` を超えると `ContractError` で停止します。

### ステート管理 (Storage)
`storage` 変数への読み書きは、データベースへのアクセス（`store_get`, `store_set` オペレーション）に変換されます。
これにより、コントラクトの実行が終わってもデータが保持されます。

### トランザクション管理
コントラクト実行中にエラーが発生した場合、あるいは `cancel()` が呼び出された場合、その実行中に行われたすべてのデータベース操作（送金、ストレージ更新など）はロールバックされます。これはデータベースのトランザクション機能を利用して実現されています。

## コントラクトの安全性

VMはサンドボックス化されており、以下の機能は持っていません。

- ファイルシステムへのアクセス
- ネットワークソケットの作成
- `subprocess` 等による外部プロセスの実行

これにより、悪意のあるコードがホストサーバーに損害を与えることを防いでいます。
