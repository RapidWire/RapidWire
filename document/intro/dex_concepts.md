# 分散型取引所 (DEX) の仕組み

RapidWireには、UniswapなどのDeFiプロトコルで採用されている **AMM (Automated Market Maker: 自動マーケットメイカー)** モデルに基づいた分散型取引所（DEX）機能が組み込まれています。

これにより、中央集権的な管理者やオーダーブック（板）なしで、ユーザー同士が通貨を自由に交換できます。

## AMMとは？

従来の取引所（CEX）では、「買いたい人」と「売りたい人」の注文（オーダー）をマッチングさせることで取引が成立します。しかし、流動性が低い（参加者が少ない）市場では、取引相手が見つからず売買が成立しないことがあります。

AMMでは、**流動性プール (Liquidity Pool)** と呼ばれるスマートコントラクト（プログラム）が取引相手となります。ユーザーはプールに対して通貨を交換します。価格は、プール内の通貨のバランスによって数式に基づいて自動的に決定されます。

## 流動性プール (Liquidity Pool)

流動性プールは、2つの異なる通貨（ペア）の在庫を貯めておく場所です。例えば、「Gold」と「Silver」のプールなどです。

### 流動性提供者 (Liquidity Provider: LP)
プールの在庫は、**流動性提供者**と呼ばれるユーザーたちによって提供されます。誰でも自分の持っている2つの通貨をプールに預け入れることで、流動性提供者になることができます。
流動性を提供すると、その証明として **LPトークン（シェア）** を受け取ります。

### 取引手数料
ユーザーがスワップ（交換）を行う際、少額の手数料（Fee）が徴収されます。この手数料はプールに蓄積され、流動性提供者に分配されます。つまり、流動性を提供することは、取引手数料という収入を得る投資機会となります。

## 価格決定の仕組み (Constant Product Formula)

RapidWireのDEXは、基本的な **定数積算式 (x * y = k)** を採用しています。

- $x$: プール内の通貨Aの量
- $y$: プール内の通貨Bの量
- $k$: 定数（流動性の総量）

この式は、「スワップの前後で、プール内の2つの通貨の量の積（掛け算の結果）が変わらないようにする」というルールです。

### 具体例
あるプールに、**1,000 Gold ($x$)** と **4,000 Silver ($y$)** があるとします。
$1,000 \times 4,000 = 4,000,000$ ($k$)

この状態で、あなたが **100 Gold** をプールに入れて、Silverと交換しようとします。

1.  プール内のGoldは $1,000 + 100 = 1,100$ になります。
2.  ルール $x \times y = k$ を守るため、新しいSilverの量 $y'$ は $4,000,000 \div 1,100 \approx 3,636$ にならなければなりません。
3.  もともと4,000あったSilverが3,636になるので、差額の $4,000 - 3,636 = 364$ Silver があなたに払い出されます。

結果として、**100 Gold** で **364 Silver** を手に入れました。
レートは $1 \text{ Gold} = 3.64 \text{ Silver}$ です。

もし、さらにGoldを売ろうとすると、プール内のGoldが増え、Silverが減るため、1 Goldあたりで貰えるSilverの量は徐々に減っていきます。これが需要と供給による価格変動のメカニズムです。

## 変動損失 (Impermanent Loss)

流動性提供者にはリスクもあります。それが **変動損失** です。
プールの外での市場価格が大きく変動した場合、プール内の比率も裁定取引（アービトラージ）によって変動します。その結果、単に2つの通貨をウォレットで持っていた場合と比べて、資産価値が目減りしてしまう現象です。

しかし、十分な取引量があり、手数料収入がこの損失を上回れば、流動性提供は利益を生みます。

## まとめ

- **DEX** により、いつでも即座に通貨の交換が可能です。
- **流動性プール** はユーザーみんなで作り上げる市場です。
- **流動性提供** をすることで、取引手数料を得ることができます。
- 価格は **$x \times y = k$** の数式によって自動的に決まります。
