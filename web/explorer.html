<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RapidWire Explorer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="univ.css">
</head>
<body class="bg-slate-50">

    <div class="container max-w-6xl mx-auto p-4 md:p-8">
        
        <header class="mb-8 pb-4 border-b border-slate-200">
            <h1 class="text-3xl font-bold text-blue-600">RapidWire Explorer</h1>
            <p class="text-slate-600 mt-2">
                リアルタイムのトランザクション、アドレス、コントラクトを探索します。
                <a href="index.html" class="text-sm font-medium text-blue-600 hover:underline ml-4">&larr; Home</a>
            </p>
        </header>

        <div class="bg-white p-4 rounded-lg shadow-md border border-slate-200 mb-8">
            <div class="flex flex-col md:flex-row gap-4">
                <input type="text" id="searchInput" placeholder="Search by User ID (Address), Tx ID..." class="flex-grow p-3 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent font-mono">
                <select id="sort_by" class="p-3 border border-slate-300 rounded-md">
                    <option value="transaction_id">Transaction ID</option>
                    <option value="timestamp">Timestamp</option>
                    <option value="amount">Amount</option>
                </select>
                <select id="sort_order" class="p-3 border border-slate-300 rounded-md">
                    <option value="desc">Descending</option>
                    <option value="asc">Ascending</option>
                </select>
                <button id="searchButton" class="bg-blue-600 text-white font-semibold px-6 py-3 rounded-md hover:bg-blue-700 transition-colors">
                    Search
                </button>
                <button id="resetButton" class="bg-slate-200 text-slate-700 font-semibold px-6 py-3 rounded-md hover:bg-slate-300 transition-colors">
                    Reset
                </button>
            </div>
        </div>

        <h2 class="text-xl font-semibold mb-6">Recent Transactions</h2>
        <div id="tx-card-container" class="space-y-6">
        </div>

        <div class="flex justify-between items-center mt-10">
            <button id="prevButton" class="bg-white text-slate-700 font-semibold px-5 py-2 rounded-md border border-slate-300 hover:bg-slate-100 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                &larr; Previous
            </button>
            <div id="pageInfo" class="text-sm text-slate-600">
                Page 1
            </div>
            <button id="nextButton" class="bg-white text-slate-700 font-semibold px-5 py-2 rounded-md border border-slate-300 hover:bg-slate-100 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                Next &rarr;
            </button>
        </div>
    </div>

<script src="univ.js"></script>
<script>
    const LIMIT = 20;
    let currentPage = 1;
    let currentSearchQuery = null;

    const searchInput = document.getElementById('searchInput');
    const cardContainer = document.getElementById('tx-card-container');
    const prevButton = document.getElementById('prevButton');
    const nextButton = document.getElementById('nextButton');
    const pageInfo = document.getElementById('pageInfo');

    async function getCurrency(currencyId) {
        return await fetchWithCache(`${API_BASE_URL}/currency/id/${currencyId}`);
    }

    async function displayTransactions(transactions) {
        cardContainer.innerHTML = '';
        if (transactions.length === 0) {
            cardContainer.innerHTML = `<div class="text-center p-12 text-slate-500 italic bg-white rounded-lg shadow-md border border-slate-200">No transactions found.</div>`;
            return;
        }

        const currencyPromises = transactions.map(tx => getCurrency(tx.currency_id));
        const currencies = await Promise.all(currencyPromises);

        const sourceLinkPromises = transactions.map(tx => formatUserLink(tx.source_id));
        const destLinkPromises = transactions.map(tx => formatUserLink(tx.dest_id));
        
        const sourceLinks = await Promise.all(sourceLinkPromises);
        const destLinks = await Promise.all(destLinkPromises);

        transactions.forEach((tx, index) => {
            const currency = currencies[index];
            const timestamp = new Date(tx.timestamp * 1000).toLocaleString();
            
            const sourceLink = sourceLinks[index];
            const destLink = destLinks[index];

            const cardHTML = `
            <div class="bg-white rounded-lg shadow-md border border-slate-200 hover:shadow-lg transition-shadow">
                <div class="p-6">
                    <div class="flex flex-col md:flex-row md:items-center justify-between">
                        <div class="mb-4 md:mb-0">
                            <a href="transaction.html?id=${tx.transaction_id}" class="font-mono text-lg font-medium text-blue-600 hover:underline">
                                Tx #${tx.transaction_id}
                            </a>
                            <div class="text-sm text-slate-500 mt-1">
                                ${timestamp}
                            </div>
                        </div>
                        
                        <div class="flex items-center">
                            <div class="flex-1 text-right md:text-left">
                                <div class="text-sm text-slate-500">From</div>
                                ${sourceLink}
                            </div>
                            <span class="mx-4 text-2xl text-slate-400">→</span>
                            <div class="flex-1">
                                <div class="text-sm text-slate-500">To</div>
                                ${destLink}
                            </div>
                        </div>

                        <div class="mt-4 md:mt-0 md:text-right">
                            <div class="text-xl font-bold font-mono text-slate-800">
                                ${formatAmount(tx.amount, networkDecimals)}
                            </div>
                            <div class="text-sm font-semibold text-slate-500">
                                ${currency.symbol}
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-slate-50 px-6 py-3 border-t border-slate-200 rounded-b-lg">
                    <span class="text-xs font-semibold text-slate-500 mr-2">DATA:</span>
                    <code class="text-sm font-mono text-slate-700">${tx.input_data || '—'}</code>
                </div>
            </div>
            `;
            cardContainer.innerHTML += cardHTML;
        });
    }

    async function fetchAndDisplay(page = 1) {
        currentPage = page;
        pageInfo.textContent = `Page: ${currentPage}`;
        prevButton.disabled = (currentPage === 1);

        const sortBy = document.getElementById('sort_by').value;
        const sortOrder = document.getElementById('sort_order').value;

        let url = `${API_BASE_URL}/transactions/search?page=${currentPage}&limit=${LIMIT}&sort_by=${sortBy}&sort_order=${sortOrder}`;

        if (currentSearchQuery) {
            url += `&user_id=${currentSearchQuery}`;
        }

        cardContainer.innerHTML = `<div class="text-center p-12 text-slate-500 italic">Loading...</div>`;

        try {
            const response = await fetch(url);
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.detail || `Request failed: ${response.status}`);
            }
            const transactions = await response.json();

            await displayTransactions(transactions);
            nextButton.disabled = (transactions.length < LIMIT);
        } catch (error) {
            cardContainer.innerHTML = `<div class="p-4 text-red-700 bg-red-100 border border-red-300 rounded-md">Failed to fetch transactions: ${error.message}</div>`;
            nextButton.disabled = true;
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        getConfig().then(() => fetchAndDisplay(1));

        prevButton.addEventListener('click', () => { if (currentPage > 1) fetchAndDisplay(currentPage - 1); });
        nextButton.addEventListener('click', () => fetchAndDisplay(currentPage + 1));
        document.getElementById('searchButton').addEventListener('click', () => {
            currentSearchQuery = searchInput.value.trim();
            fetchAndDisplay(1);
        });
        searchInput.addEventListener('keyup', (event) => { if (event.key === 'Enter') document.getElementById('searchButton').click(); });
        document.getElementById('resetButton').addEventListener('click', () => {
            currentSearchQuery = null;
            searchInput.value = '';
            fetchAndDisplay(1);
        });
    });
</script>
</body>
</html>
